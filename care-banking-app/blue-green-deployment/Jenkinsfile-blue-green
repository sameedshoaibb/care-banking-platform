pipeline {
    agent any

    parameters {
        string(
            name: 'NEW_VERSION',
            defaultValue: '',
            description: 'New image version to deploy (e.g., v1.0.3). Leave empty to skip update.'
        )
        choice(
            name: 'TARGET_SLOT',
            choices: ['blue', 'green'],
            description: 'Which slot to switch traffic to?'
        )
    }

    stages {
        stage('Info') {
            steps {
                sh '''
                    set +x
                    echo "Switch traffic to: ${TARGET_SLOT}"
                '''
            }
        }

        stage('Check Current Traffic') {
            steps {
                sh '''
                    set +x
                    echo ""
                    echo "=== CURRENT STATUS ==="
                    echo ""
                    CURRENT=$(kubectl get service care-banking-app -n care-banking-app -o jsonpath="{.spec.selector.slot}")
                    echo "Traffic is routing to: $CURRENT"
                    echo ""
                    echo "Pod IPs:"
                    kubectl get pods -n care-banking-app -l slot=$CURRENT -o wide | grep -v NAME
                    echo ""
                    echo "Service Endpoints:"
                    kubectl get endpoints care-banking-app -n care-banking-app
                    echo ""
                '''
            }
        }

        stage('Switch Traffic') {
            steps {
                sh '''
                    set +x
                    echo ""
                    echo "=== SWITCHING TRAFFIC ==="
                    echo ""
                    kubectl patch service care-banking-app \
                        -n care-banking-app \
                        --type merge \
                        -p '{"spec":{"selector":{"slot":"'"${TARGET_SLOT}"'"}}}'
                    echo "Traffic switched to: ${TARGET_SLOT}"
                    echo ""
                '''
            }
        }

        stage('Verify') {
            steps {
                sh '''
                    set +x
                    echo ""
                    echo "=== FINAL STATUS ==="
                    echo ""
                    NEW=$(kubectl get service care-banking-app -n care-banking-app -o jsonpath="{.spec.selector.slot}")
                    echo "Traffic is now routing to: $NEW"
                    echo ""
                    echo "Pod IPs:"
                    kubectl get pods -n care-banking-app -l slot=$NEW -o wide | grep -v NAME
                    echo ""
                    echo "Service Endpoints:"
                    kubectl get endpoints care-banking-app -n care-banking-app
                    echo ""
                '''
            }
        }
    }

    post {
        success {
            sh '''
                set +x
                echo "SUCCESS: Traffic is now routing to ${TARGET_SLOT}"
            '''
        }
    }
}
